# IPv6

有一天，小明连上了校园网，还没有打开位于某个熟悉地方的软件时，就先打开Chrome浏览器搜索起来，和往常一样，他成功的在某个不存在的搜索引擎上找到了一些东西。正当他想要继续点开另一个不存在的网站时，网站404了。这时，小明才发现，他忘了打开那个软件。

可是他马上奇怪起来，为什么在没打开那个软件的情况下就能打开那个不存在的搜索网站？在好奇心的驱使下，他依次试验了某个名单上的网站，发现，能打开的只有狗鸽系的产品。

所以为什么呢？奇怪的他打开了cmd，开始ping狗鸽的域名，然后发现居然能够ping通！他感到惊奇，然后开始追踪路由，发现路由直接通过北京的教育网出口连接到了香港的一个服务器群。
<br>
<div align="center">
  <img src="/assets/路由追踪狗鸽.jpg"/>
  <p></p>
</div>

惊奇之余的他，发现这些解析的地址均为IPv6地址，而非普遍被ban的IPv4地址，他意识到手机的三网4G也有IPv6环境，于是他使用4G网络又测试了一遍。然而，即使狗鸽的域名已经解析为上述的服务器群的IPv6地址，却依旧ping不通。他没有放弃，选择每个运营商都试试，结果发现，解析到的服务器V6地址，无论是美国的还是香港的，校园网下均能连通，但无论采用哪家运营商的4G网络，都ping不通！

很明显，针对不同的网络出口，IPv6的防火墙的策略并不相同。

小明不禁陷入了对人生和社会的大思考。

# 正文

目前除了少数的SCUNET外，大部分的需要身份认证的校园网基本都有了原生IPv6地址，v4v6双栈，通过无状态地址自动配置方式下发，前缀长度64 (SLAAC /64)。

如果你的电脑是直接连接到了SCUNET或者有线网络的时候，电脑不需要认证就能够自动获取到IPv6地址，但是ipv6要通外网还是需要认证，外网的入网流量也会碰到防火墙。因此不能如同其他学校一样IPv6免流量使用，并且，如果你在中间使用了路由器的话，就同时需要路由器也能够支持向下分发ipv6地址，否则电脑就只能接入IPv4网络。

要让路由器支持IPv6的下发其实也有很多种方案，你可以参考[这篇帖子](http://koolshare.cn/thread-46415-1-1.html)中和[这篇wiki](https://github.com/kamingchan/SYSUv6-DNS/wiki/%E5%A6%82%E4%BD%95%E5%9C%A8%E8%B7%AF%E7%94%B1%E5%99%A8%E5%90%8E%E8%8E%B7%E5%8F%96-IPv6-%E5%9C%B0%E5%9D%80)来对路由器进行相关设置以下发IPv6地址。

一般来说，让路由器支持IPv6有以下方案：
1. **划分子网**：在学校给的子网里，强行给自己划一个更小的子网
2. **中继**：把WAN的IPv6数据包改MAC代理到LAN里面来，再把LAN的数据包改MAC代理到WAN去 （6relayd）
3. **桥接**：在WAN和LAN之间架一个只允许IPv6数据包通过的桥
4. IPv6 NAT（如：[NAPT66](https://github.com/mzweilin/napt66)）

由于划分子网不一定支持Android，所以放弃；由于桥接不支持需要认证才能通外网的川大校园网，所以放弃；由于Padavan的Linux内核原生不支持ipv6的NAT，如需NAT需要编译相关模块，太麻烦，放弃（OpenWRT/LEDE 可使用 kmod-ipt-nat6 内核模块实现 NAT66）。

所以介绍通过6relayd中继使路由器下发IPv6的方案。

原理是使用6relayd来收集WAN口的IPv6数据包，将其源MAC地址改为路由自己，RA、DHCPv6中的默认路由等信息也改成路由自己，再发送到LAN。同样地，也会收集LAN的IPv6数据包，将源MAC改为自己，发送到WAN中。

这样一来，对于上级交换机而言，只有这一个MAC地址在通信，从而可以通过认证。对于客户端而言，默认网关就是路由器。算是“欺上瞒下”。

不过 6relayd 不是很稳定，如果长时间没有ipv6流量可能会自动掉线。在后期需要添加定时任务防掉线。

## 老毛子使用6relayd步骤：
### 1. 设置IPV6页：

<div align="center">
  <img src="/assets/IPV6%20(2).jpg"/>
  <p>先将IPv6获取的方式设置为stateless，记得先将路由器连上网</p>
</div>

### 2. 安装OPKG：
- 老毛子像openwrt一样安装额外的软件包需要U盘，或者用内存代替，这里我用了一个老U盘来用。U盘至少得1G，当然大点更好。（淘宝一个8G U盘十块钱，所以还是建议别浪费内存）
- 插入U盘并勾选“移除并格式化为EXT4”，然后移除之后，待Log界面提示格式化完成后（几十秒左右）重新插拔U盘。
  <div align="center">
    <img src="/assets/IPV6%20(3).jpg"/>
    <p>格式化U盘为EXT4</p>
  </div>
  <div align="center">
    <img src="/assets/IPV6%20(1).jpg"/>
    <p>格式化完成的提示</p>
  </div>
- 如果你执意要用内存代替，也可以不用以上步骤，直接在管理后台开启 opt 环境：设置路径在“扩展功能”-“配置扩展功能”-“opt环境”，启用 opt 自动更新、启用扩展脚本自动更新、打开 opt 强制安装、opt 安装模式选择“自动选择:SD→U盘→内存”。打开之后在 log 中会有安装的过程，出现类似【opt】: opt 挂载正常：tmpfs的日志说明 opt 环境已经安装成功。
- 看看是否加载成功
  ```
  mount
  ```
  如果出现 ``/dev/sda1 on /media/AiDisk_a1 type ext4 (rw,noatime) ``字样就是成功了。
- 建立对应的opt目录:
  ```
  mkdir /media/AiDisk_a1/opt
  mount -o bind /media/AiDisk_a1/opt /opt
  ```
- 初始化opkg
  ```
  opkg.sh
  ```
  等待1分钟左右，如果没有出现错误提示就可以了。
  如果有错误提示，重复执行这句，直到没有为止。
  如果错误5次以上，那说明你的网络没办法连接 entware.net 服务器，这个就要自己想办法了。(不要在路由器没办法联网的时候安装)
- 查看opkg是否正常以及更新update：
  ```
  opkg list
  opkg update
  ```
### 3. 安装并开启6relayd：
- 执行以下代码：
  ```
  opkg install 6relayd
  6relayd -d -A eth2.2 br0
  ```
- 这里的 eth2.2 是 WAN 网口的网卡名称，可用 ifconfig 命令来查看，记得修改。而 br0 则代表LAN网卡名称，一般不用更改。
- 然后你就会发现你的设备里已经有IPv6地址啦。
- 以后每次路由器重启联网后都可以在“系统管理 - 控制台”里输入下面的命令启动6relayd：
  ```
  6relayd -d -A eth2.2 br0
  ```
- 启动成功后控制台会输出以下信息：
  <div align="center">
    <img src="/assets/6relayd运行结果.jpg"/>
  </div>

### 4. 定时任务：
6relayd一段时间不用就会自动掉线，所以我们设置一个定时任务去ping QQ 的v6地址：

在 ‘高级设置->系统管理->服务->计划任务’  加入一条任务，每半小时执行一次ping -6，记得保存设置:
```
*/30 * * * * ping -6 -c 2 www.qq.com
```
### 5. 测速：
能打开这个[东北大学IPv6测速网站](http://speed.neu6.edu.cn/)证明已经具有IPv6环境了。

也可以看[这个网页](https://test-ipv6.com/index.html.zh_CN)的结果看IPv6的状态。
